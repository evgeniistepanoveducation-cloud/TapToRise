<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tap to Earn XP with Wheel of Fortune</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; }
    #mainContent { padding: 20px; transition: filter 0.3s; }
    button { padding: 10px 20px; font-size: 18px; cursor: pointer; }
    #xpDisplay, #levelDisplay { margin: 10px 0; font-size: 20px; }

    /* Wheel overlay */
    #wheelOverlay {
        display: none;
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        justify-content: center; align-items: center;
        z-index: 10;
    }
    #wheelCanvas {
        width: 80vw; height: 80vw; max-width: 500px; max-height: 500px;
        background: white; border-radius: 50%;
    }
    /* Red indicator triangle */
    #indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0; height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-bottom: 30px solid red;
        transform: translate(-50%, -260px);
        pointer-events: none;
        z-index: 20;
    }
    /* Message box */
    #message {
        display: none;
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: lightblue;
        padding: 20px;
        border-radius: 15px;
        font-size: 20px;
        z-index: 30;
    }
</style>
</head>
<body>
<div id="mainContent">
    <div id="xpDisplay">XP: 0</div>
    <div id="levelDisplay">Level: 1</div>
    <button id="tapBtn">Tap</button>
</div>

<div id="wheelOverlay">
    <div id="indicator"></div>
    <canvas id="wheelCanvas"></canvas>
</div>
<div id="message"></div>

<script>
let xp = 0;
let level = 1;
const xpDisplay = document.getElementById("xpDisplay");
const levelDisplay = document.getElementById("levelDisplay");
const tapBtn = document.getElementById("tapBtn");
const wheelOverlay = document.getElementById("wheelOverlay");
const message = document.getElementById("message");
const wheelCanvas = document.getElementById("wheelCanvas");
const ctx = wheelCanvas.getContext("2d");

const prizes = ["üç¨", "‚≠ê", "üíé", "üéÅ", "üî•", "üí∞"];
const probabilities = [0.3, 0.25, 0.2, 0.15, 0.07, 0.03];

// XP thresholds for levels
let thresholds = [0, 50, 150]; // level 1‚Äì3 fixed
let k = 1.8;
for (let i = 3; i < 10; i++) {
    thresholds.push(Math.round(thresholds[i] * k / 100) * 100);
}

// Resize canvas dynamically
function resizeCanvas() {
    const size = Math.min(wheelCanvas.clientWidth, wheelCanvas.clientHeight);
    wheelCanvas.width = size;
    wheelCanvas.height = size;
    drawWheel();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Draw wheel
function drawWheel(rotation=0) {
    const N = prizes.length;
    const center = wheelCanvas.width / 2;
    const radius = center - 10;

    ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

    for (let i = 0; i < N; i++) {
        let start = (i / N) * 2 * Math.PI + rotation;
        let end = ((i+1) / N) * 2 * Math.PI + rotation;

        ctx.beginPath();
        ctx.moveTo(center, center);
        ctx.arc(center, center, radius, start, end);
        ctx.fillStyle = `hsl(${i * 360 / N}, 70%, 60%)`;
        ctx.fill();
        ctx.stroke();

        ctx.save();
        ctx.translate(center, center);
        ctx.rotate(start + (end-start)/2);
        ctx.textAlign = "right";
        ctx.font = `${radius*0.2}px Arial`;
        ctx.fillStyle = "black";
        ctx.fillText(prizes[i], radius*0.9, 10);
        ctx.restore();
    }
}

// Weighted random prize
function choosePrizeByProbability() {
    let r = Math.random();
    let cum = 0;
    for (let i = 0; i < probabilities.length; i++) {
        cum += probabilities[i];
        if (r < cum) return i;
    }
    return probabilities.length-1;
}

// Spin wheel animation
function spinWheel(){
    wheelOverlay.style.display = 'flex';
    mainContent.style.filter = 'blur(5px)';

    const chosenIndex = choosePrizeByProbability();
    const N = prizes.length;
    const fullSpins = 5;
    const sectorAngle = 2 * Math.PI / N;
    const targetAngle = 3 * Math.PI / 2 - (chosenIndex + 0.5) * sectorAngle;
    const totalRotation = fullSpins * 2 * Math.PI + targetAngle;

    let start = null;
    const duration = 3000;

    function animate(ts){
        if(!start) start = ts;
        const elapsed = ts - start;
        const t = Math.min(elapsed / duration, 1);

        const ease = t < 0.5
            ? 4 * t * t * t
            : 1 - Math.pow(-2 * t + 2, 3) / 2;

        drawWheel(totalRotation * ease);

        if(t < 1){
            requestAnimationFrame(animate);
        } else {
            setTimeout(()=>{
                message.textContent = `You won ${prizes[chosenIndex]}!`;
                message.style.display = 'block';
                wheelOverlay.style.display = 'none';
                mainContent.style.filter = 'none';
                setTimeout(()=>{ message.style.display = 'none'; }, 2000);
            }, 200);
        }
    }

    requestAnimationFrame(animate);
}

// Tap button logic
tapBtn.addEventListener("click", () => {
    xp += 10;
    xpDisplay.textContent = "XP: " + xp;

    if (level < thresholds.length && xp >= thresholds[level]) {
        level++;
        levelDisplay.textContent = "Level: " + level;
        message.textContent = "Congrats, next level achieved! You earned one spin!";
        message.style.display = "block";
        mainContent.style.filter = "blur(5px)";
        // Add spin button inside message
        message.innerHTML = `
            <p>Congrats, next level achieved!</p>
            <p>You earned one spin!</p>
            <button id="spinBtn">Spin</button>
        `;
        document.getElementById("spinBtn").onclick = () => {
            message.style.display = "none";
            mainContent.style.filter = "none";
            spinWheel();
        };
    }
});
</script>
</body>
</html>
